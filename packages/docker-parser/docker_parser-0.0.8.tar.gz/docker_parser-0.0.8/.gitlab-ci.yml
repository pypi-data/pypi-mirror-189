image: python:latest

stages:
  - test
  - deploy

before_script:
  - python --version
  - pip install virtualenv
  - virtualenv venv
  - source venv/bin/activate

unit_test:
  stage: test
  script:
   - pip install -r requirements.txt
   - python tests/tests.py
  tags:
    - shared-fi

examples:
  stage: test
  script:
   - pip install -r requirements.txt
   - python examples/create_dockerfile.py -i httpd -s ./public_html/ test.dockerfile
   - python examples/to_ansible.py tests/dockerfiles/simple/all_commands.dockerfile ./test.yml
  tags:
    - shared-fi

publish:
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - pyproject.toml
      variables:
        REPOSITORY: pypi
        PASSWORD: $PYPI_TOKEN
    - if: $CI_COMMIT_BRANCH == "preprod"
      changes:
        - pyproject.toml
      variables:
        REPOSITORY: testpypi
        PASSWORD: $TEST_PYPI_TOKEN
  script:
    - pip install build twine
    - python -m build
    - python3 -m twine upload --repository ${REPOSITORY} dist/* --verbose -u __token__ -p ${PASSWORD}
  tags:
    - shared-fi